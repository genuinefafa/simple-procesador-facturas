#!/bin/bash
# Pre-commit hook: Formatear c√≥digo y validar archivos antes de commitear

set -e

# Auto-formatear archivos TypeScript y Svelte con Prettier
echo "üé® Formateando c√≥digo con Prettier..."

# Obtener archivos .ts y .svelte en staging (excluyendo node_modules)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|svelte)$' | grep -v 'node_modules' || true)

if [ -n "$STAGED_FILES" ]; then
  echo "üìù Formateando archivos TypeScript y Svelte:"
  echo "$STAGED_FILES" | sed 's/^/  - /'

  # Formatear archivos en staging
  echo "$STAGED_FILES" | xargs npx prettier --write

  # Re-agregar archivos formateados al staging
  echo "$STAGED_FILES" | xargs git add

  echo "‚úÖ Archivos formateados"
else
  echo "‚úÖ No hay archivos TypeScript o Svelte para formatear"
fi

echo ""
echo "üîç Validando archivos Svelte..."

# Obtener archivos .svelte en staging
SVELTE_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.svelte$' || true)

if [ -z "$SVELTE_FILES" ]; then
  echo "‚úÖ No hay archivos .svelte para validar"
  exit 0
fi

echo "üìù Archivos a validar:"
echo "$SVELTE_FILES" | sed 's/^/  - /'

# Validar sintaxis b√°sica con grep
echo ""
echo "üîé Verificando sintaxis b√°sica..."

ERRORS=0
while IFS= read -r file; do
  # Verificar errores comunes
  if grep -n '<\/[a-z]*}' "$file" > /dev/null 2>&1; then
    echo "‚ùå Error en $file: etiqueta de cierre con } en lugar de >"
    grep -n '<\/[a-z]*}' "$file"
    ERRORS=$((ERRORS + 1))
  fi

  if grep -n '{\/if}' "$file" > /dev/null 2>&1; then
    echo "‚ö†Ô∏è  Advertencia en $file: posible error en bloque {/if}"
  fi
done <<< "$SVELTE_FILES"

if [ $ERRORS -gt 0 ]; then
  echo ""
  echo "‚ùå Se encontraron $ERRORS error(es) de sintaxis."
  echo "   Por favor, corregalos antes de commitear."
  exit 1
fi

# Si hay SvelteKit en client/, correr svelte-check
if [ -d "client" ] && [ -f "client/package.json" ]; then
  echo ""
  echo "üî¨ Ejecutando svelte-check (puede tardar)..."

  # Solo correr en los archivos modificados
  if ! (cd client && npm run check > /dev/null 2>&1); then
    echo ""
    echo "‚ö†Ô∏è  svelte-check encontr√≥ errores de tipos."
    echo "   Pod√©s ver los detalles con: cd client && npm run check"
    echo ""
    read -p "¬øQuer√©s commitear igual? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      echo "‚ùå Commit cancelado"
      exit 1
    fi
  fi
fi

echo ""
echo "‚úÖ Validaci√≥n completada"
exit 0
