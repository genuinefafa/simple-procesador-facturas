#!/bin/bash
# Pre-commit hook: Formatear c√≥digo y validar archivos antes de commitear

set -e

# Auto-formatear archivos TypeScript y Svelte con Prettier
echo "üé® Formateando c√≥digo con Prettier..."

# Obtener archivos .ts y .svelte en staging (excluyendo node_modules)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|svelte)$' | grep -v 'node_modules' || true)

if [ -n "$STAGED_FILES" ]; then
  echo "üìù Formateando archivos TypeScript y Svelte:"
  echo "$STAGED_FILES" | sed 's/^/  - /'

  # Formatear archivos en staging
  echo "$STAGED_FILES" | xargs npx prettier --write

  # Re-agregar archivos formateados al staging
  echo "$STAGED_FILES" | xargs git add

  echo "‚úÖ Archivos formateados"
else
  echo "‚úÖ No hay archivos TypeScript o Svelte para formatear"
fi

echo ""
echo "üîç Validando archivos Svelte..."

# Obtener archivos .svelte en staging
SVELTE_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.svelte$' || true)

if [ -z "$SVELTE_FILES" ]; then
  echo "‚úÖ No hay archivos .svelte para validar"
  exit 0
fi

echo "üìù Archivos a validar:"
echo "$SVELTE_FILES" | sed 's/^/  - /'

# Validar sintaxis b√°sica con grep
echo ""
echo "üîé Verificando sintaxis b√°sica..."

ERRORS=0
while IFS= read -r file; do
  # Verificar errores comunes
  if grep -n '<\/[a-z]*}' "$file" > /dev/null 2>&1; then
    echo "‚ùå Error en $file: etiqueta de cierre con } en lugar de >"
    grep -n '<\/[a-z]*}' "$file"
    ERRORS=$((ERRORS + 1))
  fi

  if grep -n '{\/if}' "$file" > /dev/null 2>&1; then
    echo "‚ö†Ô∏è  Advertencia en $file: posible error en bloque {/if}"
  fi
done <<< "$SVELTE_FILES"

if [ $ERRORS -gt 0 ]; then
  echo ""
  echo "‚ùå Se encontraron $ERRORS error(es) de sintaxis."
  echo "   Por favor, corregalos antes de commitear."
  exit 1
fi

# Validaci√≥n TypeScript estricta (igual que CI)
echo ""
echo "üî¨ Validando TypeScript y Svelte (client)..."
if ! (cd client && npx svelte-check --fail-on-warnings --threshold error); then
  echo ""
  echo "‚ùå Errores de TypeScript/Svelte en client/"
  echo "   Us√° 'git commit --no-verify' para saltear esta validaci√≥n (no recomendado)"
  exit 1
fi

echo ""
echo "üî¨ Validando TypeScript (server)..."
if ! (cd server && npx tsc --noEmit); then
  echo ""
  echo "‚ùå Errores de TypeScript en server/"
  echo "   Us√° 'git commit --no-verify' para saltear esta validaci√≥n (no recomendado)"
  exit 1
fi

echo ""
echo "‚úÖ Validaci√≥n completada"
exit 0
